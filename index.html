<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carrier Shark â€“ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style1.css">
</head>
<body class="carrier-list">
  <div class="bg-gradient"></div>
  <div class="bg-grid"></div>

  <!-- ðŸ”¥ ADD HEADER HERE -->
  <header class="site-header glass-nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">CARRIER SHARK</a>
      </div>

      <nav class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/privacy" class="nav-link">Privacy Policy</a>
      </nav>
    </div>
  </header>
  <!-- ðŸ”¥ END ADDED HEADER -->

  <div class="page">
    <header class="page-header">
      <div class="page-header-left">
        <h1 class="page-title">Carrier Shark</h1>
        <p class="page-subtitle">Find and manage vetted carriers</p>
      </div>
    </header>

    <!-- SEARCH SECTION -->
    <section class="glass-card search-shell">
      <div class="search-shell-header">
        <div>
          <h2 class="search-title">Search Carriers</h2>
          <p class="search-subtitle">Search by DOT number or carrier name</p>
        </div>
      </div>

      <div class="search-row">
        <input
          id="search-input"
          class="search-input"
          type="text"
          placeholder="Start typing a DOT or carrier name..."
          autocomplete="off"
        />
        <button id="open-carrier-btn" class="search-btn">Search</button>
      </div>

      <ul id="carrier-suggestions" class="carrier-suggestions"></ul>
    </section>

    <!-- LIST SECTION -->
    <section class="glass-card carriers-card">
      <header class="carriers-card-header">
        <div>
          <h2 class="carriers-title">My Carriers</h2>
          <p class="carriers-subtitle">Click a DOT number to open its profile page.</p>
        </div>
      </header>

      <div class="carriers-table-wrap">
        <table class="carriers-table">
          <thead>
            <tr>
              <th>DOT</th>
              <th>MC</th>
              <th>Carrier</th>
              <th>Location</th>
              <th>Operating Status</th>
              <th>Common</th>
              <th>Contract</th>
              <th>Broker</th>
              <th>Safety Rating</th>
            </tr>
          </thead>
          <tbody id="carrier-table-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ---------- TABLE LOAD ----------
    async function loadCarriers() {
      try {
        const res = await fetch('/api/carriers');
        const data = await res.json();
        const tbody = document.getElementById('carrier-table-body');

        if (!Array.isArray(data) || data.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'No carriers found.';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        

        data.forEach(c => {
          const row = document.createElement('tr');
          const dotVal = c.dot || c.dotnumber || c.id || '';


          

          const dotCell = document.createElement('td');
          const link = document.createElement('a');
          link.textContent = dotVal;
          link.href = '/' + encodieURIComponent(dotVal);
          link.className = 'dot-link';
          dotCell.appendChild(link);
          row.appendChild(dotCell);


          const mcCell = document.createElement('td');
          mcCell.textContent = c.hazmatoosratenationalaverage || 'â€”';
          row.appendChild(mcCell)

          // --- 1) CARRIER NAME ---
          const nameCell = document.createElement('td');
          nameCell.textContent = c.legalname || c.dbaname || c.name || 'â€”';
          row.appendChild(nameCell);

         const locationCell = document.createElement('td');
          locationCell.textContent = `${(c.city || c.phycity || '')}${
            (c.state || c.phystate) ? ', ' + (c.state || c.phystate) : ''
          }`;
          row.appendChild(locationCell);
          
          const allowedtooperateCell = document.createElement('td');
          allowedtooperateCell.textContent = c.allowedtooperate === 'Y'
            ? 'Authorized'
            : 'Not Authorized';
          row.appendChild(allowedtooperateCell);
          
          
 

          const commonCell = document.createElement('td');
          commonCell.textContent = c.commonauthoritystatus || 'â€”';
          row.appendChild(commonCell);
          
          const contractCell = document.createElement('td');
          contractCell.textContent = c.contractauthoritystatus || 'â€”';
          row.appendChild(contractCell);

          const brokerCell = document.createElement('td');
          brokerCell.textContent = c.brokerauthoritystatus || 'â€”';
          row.appendChild(brokerCell);

          const safetyCell = document.createElement('td');
          safetyCell.textContent = c.safetyrating || 'Not Rated';
          row.appendChild(safetyCell);


          row.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'a') {
              window.location.pathname = '/' + encodeURIComponent(dotVal);
            }
          });

          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error fetching carriers:', err);
      }
    }

    // ---------- SEARCH / AUTOCOMPLETE ----------
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('open-carrier-btn');
    const suggestionsEl = document.getElementById('carrier-suggestions');
    let searchTimeout = null;

    function clearSuggestions() {
      suggestionsEl.innerHTML = '';
      suggestionsEl.classList.remove('open');
    }

    function goToCarrier(dot) {
      if (!dot) return;
      window.location.pathname = '/' + encodeURIComponent(dot);
    }

    function renderSuggestions(results) {
      clearSuggestions();
      if (!Array.isArray(results) || results.length === 0) return;

      results.forEach(item => {
        const li = document.createElement('li');
        li.className = 'carrier-suggestion-item';
        const dotVal = item.dot || item.dotnumber || item.id || '';
        const name = item.legalname || item.dbaname || '(No name)';
        const city = item.city || item.phycity || '';
        const state = item.state || item.phystate || '';

        li.innerHTML = `
          <div class="suggestion-main">${dotVal} â€“ ${name}</div>
          <div class="suggestion-sub">${city}${city && state ? ', ' : ''}${state}</div>
        `;
        li.addEventListener('click', () => goToCarrier(dotVal));
        suggestionsEl.appendChild(li);
      });

      suggestionsEl.classList.add('open');
    }

    async function performSearch(query) {
      const q = query.trim();
      if (q.length < 2) {
        clearSuggestions();
        return;
      }

      try {
        const res = await fetch('/api/carriers/search?q=' + encodeURIComponent(q));
        const data = await res.json();
        renderSuggestions(data);
      } catch (err) {
        console.error('Error searching carriers:', err);
      }
    }

    searchInput.addEventListener('input', () => {
      const value = searchInput.value;
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(value), 250);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const first = suggestionsEl.querySelector('.carrier-suggestion-item');
        if (first) {
          const text = first.querySelector('.suggestion-main').textContent || '';
          const dot = text.split('â€“')[0].trim();
          goToCarrier(dot);
        } else {
          goToCarrier(searchInput.value.trim());
        }
      }
    });

    searchBtn.addEventListener('click', () => {
      const first = suggestionsEl.querySelector('.carrier-suggestion-item');
      if (first) {
        const text = first.querySelector('.suggestion-main').textContent || '';
        const dot = text.split('â€“')[0].trim();
        goToCarrier(dot);
      } else {
        goToCarrier(searchInput.value.trim());
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-shell')) {
        clearSuggestions();
      }
    });

    loadCarriers();
  </script>
</body>
</html>
