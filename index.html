<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carrier Shark â€“ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style1.css">
</head>
<body class="carrier-list">
  <div class="bg-gradient"></div>
  <div class="bg-grid"></div>

  <!-- ðŸ”¥ ADD HEADER HERE  --->
  <header class="site-header glass-nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">CARRIER SHARK</a>
      </div>

      <nav class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/privacy" class="nav-link">Privacy Policy</a>
        <button id="login-btn">Login</button>
        <button id="logout-btn" style="display:none;">Logout</button>
      </nav>
    </div>
  </header>
  <!-- ðŸ”¥ END ADDED HEADER -->

  <div class="page">
    <header class="page-header">
      <div class="page-header-left">
        <h1 class="page-title">Carrier Shark</h1>
        <p class="page-subtitle">Find and manage vetted carriers</p>
      </div>
    </header>

    <!-- SEARCH SECTION -->
    <section class="glass-card search-shell">
      <div class="search-shell-header">
        <div>
          <h2 class="search-title">Search Carriers</h2>
          <p class="search-subtitle">Search by DOT number or carrier name</p>
        </div>
      </div>

<div class="search-row">
  <div class="search-input-wrap">
    <input
      id="search-input"
      class="search-input"
      type="text"
      placeholder="Start typing a DOT, MC, or Carrier Name..."
      autocomplete="off"
    />
    <ul id="carrier-suggestions" class="carrier-suggestions"></ul>
  </div>

  <button id="open-carrier-btn" class="search-btn">Search</button>
</div>


    </section>

    <!-- LIST SECTION -->
    <section class="glass-card carriers-card">
      <header class="carriers-card-header">
        <div>
          <h2 class="carriers-title">My Carriers</h2>
          <p class="carriers-subtitle">Click a DOT number to open its profile page.</p>
        </div>
      
        <div class="carriers-header-actions">
          <button id="bulk-import-btn" class="bulk-import-btn">Bulk Import</button>
          <button id="download-btn" class="download-btn">Download CSV</button>
        </div>
      </header>



      <div class="carriers-table-wrap">
        
            <div id="bulk-actions" class="bulk-actions hidden">
              <span id="selected-count">0</span> selected
              <button id="bulk-remove-btn" class="bulk-remove-btn">
                Remove selected from My Carriers
              </button>
            </div>
              
      <table id="carriers-table" class="carriers-table">
        <thead>
          <tr>
            <th class="select-cell">
              <input type="checkbox" id="select-all">
            </th>
        
            <th class="sortable" data-col="dot">
              <span class="th-label">DOT</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="mc">
              <span class="th-label">MC</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="carrier">
              <span class="th-label">Carrier</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="location">
              <span class="th-label">Location</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="operating">
              <span class="th-label">Operating</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="common">
              <span class="th-label">Common</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="contract">
              <span class="th-label">Contract</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="broker">
              <span class="th-label">Broker</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
        
            <th class="sortable" data-col="safety">
              <span class="th-label">Safety Rating</span>
              <span class="sort-icon">
                <span class="arrow-up"></span>
                <span class="arrow-down"></span>
              </span>
            </th>
          </tr>
        </thead>

        <tbody id="carrier-table-body"></tbody>
      </table>

      <!-- ðŸ”» New footer: rows-per-page + pagination -->
      <div class="table-footer">
        <div class="rows-per-page">
          Rows per page:
          <select id="rows-per-page">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      
        <div class="pagination" id="pagination-controls"></div>
      </div>
        <div class="table-tip">
  Tip: Click a column header to sort.
      </div>
    </section>
  </div>

  <script>

let carrierIndex = []; 
let myCarrierDots = new Set();

// -------- PAGINATION STATE --------
let currentPage = 1;
let pageSize = 25;       // default 25
let totalRows = 0;
let totalPages = 0;

// -------- SORT STATE (server-side) --------
// default: sort by Carrier ascending
let sortBy = 'carrier';  // 'dot', 'mc', 'carrier', etc.
let sortDir = 'asc';     // 'asc' or 'desc'


 // ---------- TABLE LOAD ----------
async function loadCarriers() {
  try {
    const tbody = document.getElementById('carrier-table-body');
    tbody.innerHTML = ''; // clear before re-render

    // ------------------------------------------
    // 1) CHECK IF USER IS LOGGED IN
    // ------------------------------------------
    let endpoint = '/api/carriers'; // default for guests

    try {
      const me = await fetch('/api/me').then(r => r.json());
      if (me.user) {
        endpoint = '/api/my-carriers'; // logged in â†’ use saved carriers
      }
    } catch (e) {
      console.error("Error checking login:", e);
    }

    // ------------------------------------------
    // 2) BUILD URL WITH PAGINATION PARAMS
    // ------------------------------------------
const url = new URL(endpoint, window.location.origin);
url.searchParams.set('page', currentPage);
url.searchParams.set('pageSize', pageSize);

// add sort params if we have a sort chosen
if (sortBy) {
  url.searchParams.set('sortBy', sortBy);
  url.searchParams.set('sortDir', sortDir);
}


    const res = await fetch(url);
    const result = await res.json();

    // API now returns: { rows, total, page, pageSize }
    const data = Array.isArray(result) ? result : result.rows;
    totalRows   = result.total ?? data.length;
    totalPages  = Math.max(1, Math.ceil(totalRows / pageSize));

    if (!Array.isArray(data) || data.length === 0) {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 10; // full width
      cell.textContent = 'No carriers found.';
      row.appendChild(cell);
      tbody.appendChild(row);

      renderPagination(); // still update controls
      return;
    }

    data.forEach(c => {
      const row = document.createElement('tr');
      const dotVal = c.dot || c.dotnumber || c.id || '';

      //  NEW: checkbox cell
      const selectCell = document.createElement('td');
      selectCell.className = 'col-select select-cell';  // add select-cell
    
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'row-select';
      checkbox.dataset.dot = dotVal;   // this is what we'll send to the API
    
      selectCell.appendChild(checkbox);
      row.appendChild(selectCell);
      

      const dotCell = document.createElement('td');
      const link = document.createElement('a');
      link.textContent = dotVal;
      link.href = '/' + encodeURIComponent(dotVal);
      link.className = 'dot-link';
      dotCell.appendChild(link);
      row.appendChild(dotCell);


      const mcCell = document.createElement('td');
      mcCell.textContent = c.mc_number || '-';
      row.appendChild(mcCell)

      // --- 1) CARRIER NAME ---
      const nameCell = document.createElement('td');
      nameCell.textContent = c.legalname || c.dbaname || c.name || '-';
      nameCell.title = c.legalname || c.dbaname || c.name || '-';   
      row.appendChild(nameCell);

      const locationCell = document.createElement('td');
      locationCell.textContent = `${(c.city || c.phycity || '')}${
        (c.state || c.phystate) ? ', ' + (c.state || c.phystate) : ''
      }`;
      row.appendChild(locationCell);
      
      const allowedtooperateCell = document.createElement('td');
      const isAuthorized = c.allowedtooperate === 'Y';
      
      allowedtooperateCell.textContent = isAuthorized
        ? 'Authorized'
        : 'Not Authorized';
      
      if (isAuthorized) {
        allowedtooperateCell.classList.add('status-ok');
      }
      
      row.appendChild(allowedtooperateCell);
      
      // COMMON
      const commonCell = document.createElement('td');
      commonCell.textContent = c.commonauthoritystatus || '-';
      if (commonCell.textContent === 'A') {
        commonCell.classList.add('status-ok');
      }
      row.appendChild(commonCell);

      // CONTRACT
      const contractCell = document.createElement('td');
      contractCell.textContent = c.contractauthoritystatus || '-';
      if (contractCell.textContent === 'A') {
        contractCell.classList.add('status-ok');
      }  
      row.appendChild(contractCell);

      // BROKER
      const brokerCell = document.createElement('td');
      brokerCell.textContent = c.brokerauthoritystatus || '-';
      if (brokerCell.textContent === 'A') {
        brokerCell.classList.add('status-ok');
      }
      row.appendChild(brokerCell);

      const ratingMap = {
        'S': 'Satisfactory',
        'C': 'Conditional',
        'U': 'Unsatisfactory'
      };

      const rawRating = c.safetyrating ? c.safetyrating.trim().toUpperCase() : '';

      const safetyCell = document.createElement('td');
      safetyCell.textContent = ratingMap[rawRating] || 'Not Rated';
      row.appendChild(safetyCell);

      row.addEventListener('click', (e) => {
        // If the click came from the checkbox column, do nothing
        if (e.target.closest('.select-cell')) {
          return;
        }
      
        // Otherwise, treat it as a row click (unless it's the DOT link itself)
        if (e.target.tagName.toLowerCase() !== 'a') {
          window.location.pathname = '/' + encodeURIComponent(dotVal);
        }
      });

      tbody.appendChild(row);
    });

    // After rows are rendered, render pagination controls
    renderPagination();
  } catch (err) {
    console.error('Error fetching carriers:', err);
  }
}


function renderPagination() {
  const container = document.getElementById('pagination-controls');
  if (!container) return;

  container.innerHTML = '';

  if (totalPages <= 1) {
    return; // nothing to show
  }

  const makeButton = (label, page, disabled = false, active = false) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.className = 'page-btn';
    if (active) btn.classList.add('active');
    if (disabled) {
      btn.disabled = true;
    } else if (page !== null) {
      btn.addEventListener('click', () => {
        if (page === currentPage) return;
        currentPage = page;
        loadCarriers();
      });
    }
    return btn;
  };

  // Prev
  container.appendChild(
    makeButton('âŸ¨', Math.max(1, currentPage - 1), currentPage === 1)
  );

  const maxButtons = 7; // 1 2 3 ... 18 style

  if (totalPages <= maxButtons) {
    // show all
    for (let p = 1; p <= totalPages; p++) {
      container.appendChild(makeButton(String(p), p, false, p === currentPage));
    }
  } else {
    // Always show 1
    container.appendChild(makeButton('1', 1, false, currentPage === 1));

    // Left ellipsis
    if (currentPage > 4) {
      const span = document.createElement('span');
      span.textContent = '...';
      span.className = 'page-ellipsis';
      container.appendChild(span);
    }

    // Middle window (currentPage -1 to +1)
    const start = Math.max(2, currentPage - 1);
    const end   = Math.min(totalPages - 1, currentPage + 1);

    for (let p = start; p <= end; p++) {
      container.appendChild(makeButton(String(p), p, false, p === currentPage));
    }

    // Right ellipsis
    if (currentPage < totalPages - 3) {
      const span = document.createElement('span');
      span.textContent = '...';
      span.className = 'page-ellipsis';
      container.appendChild(span);
    }

    // Last page
    container.appendChild(
      makeButton(String(totalPages), totalPages, false, currentPage === totalPages)
    );
  }

  // Next
  container.appendChild(
    makeButton('âŸ©', Math.min(totalPages, currentPage + 1), currentPage === totalPages)
  );
}

// Rows-per-page selector
document.getElementById('rows-per-page')?.addEventListener('change', (e) => {
  pageSize = parseInt(e.target.value, 10) || 25;
  currentPage = 1; // reset to first page when page size changes
  loadCarriers();
});



// ---------- BUILD AUTOCOMPLETE INDEX ----------
async function buildCarrierIndex() {
  try {
    // all carriers + my carriers in parallel
    const [allRes, myRes] = await Promise.all([
      fetch('/api/carriers'),
      fetch('/api/my-carriers').catch(() => null)
    ]);

    const allData = await allRes.json();
    carrierIndex = Array.isArray(allData) ? allData : [];

    // build "my carriers" DOT set if logged in
    if (myRes && myRes.ok) {
      const myData = await myRes.json();
      myCarrierDots = new Set(
        (Array.isArray(myData) ? myData : []).map(c =>
          String(c.dot || c.dotnumber || c.id || '')
        )
      );
    } else {
      myCarrierDots = new Set();
    }
  } catch (err) {
    console.error("Error building search index:", err);
    carrierIndex = [];
    myCarrierDots = new Set();
  }
}



    // ---------- SEARCH / AUTOCOMPLETE ----------
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('open-carrier-btn');
    const suggestionsEl = document.getElementById('carrier-suggestions');
    let searchTimeout = null;

    function clearSuggestions() {
      suggestionsEl.innerHTML = '';
      suggestionsEl.classList.remove('open');
    }

    function goToCarrier(dot) {
      if (!dot) return;
      window.location.pathname = '/' + encodeURIComponent(dot);
    }

function renderSuggestions(results) {
  clearSuggestions();
  if (!Array.isArray(results) || results.length === 0) return;

  results.forEach(item => {
    const li = document.createElement('li');
    li.className = 'carrier-suggestion-item';

    const dotVal = item.dot || item.dotnumber || item.id || '';
    const name   = item.legalname || item.dbaname || '(No name)';
    const city   = item.city || item.phycity || '';
    const state  = item.state || item.phystate || '';
    const mc     = item.mc_number || '-';

    const isMine = myCarrierDots.has(String(dotVal)); // ðŸ”¥ check if it's your carrier

    li.innerHTML = `
      <div class="suggestion-main">
        <span class="suggestion-title-text">
          ${dotVal} â€“ ${name}
        </span>
        ${isMine ? '<span class="my-carrier-pill">MY CARRIER</span>' : ''}
      </div>
      <div class="suggestion-sub">
        MC: ${mc} â€¢ ${city}${city && state ? ', ' : ''}${state}
      </div>
    `;

    li.addEventListener('click', () => goToCarrier(dotVal));
    suggestionsEl.appendChild(li);
  });

  suggestionsEl.classList.add('open');
}


function performSearch(query) {
  const q = query.trim();
  if (q.length < 2) {
    clearSuggestions();
    return;
  }

  // Make sure we have the global carrierIndex loaded
  if (!Array.isArray(carrierIndex) || carrierIndex.length === 0) {
    clearSuggestions();
    return;
  }

  const qLower = q.toLowerCase();

  const matches = carrierIndex
    .filter(c => {
      const dot = String(c.dot || c.dotnumber || c.id || '');
      const mc   = String(c.mc_number || ''); 
      const name = (c.legalname || c.dbaname || c.name || '').toLowerCase();

      return dot.startsWith(q) || mc.startsWith(q) || name.includes(qLower);
    })
    .slice(0, 10);

  renderSuggestions(matches);
}


    searchInput.addEventListener('input', () => {
      const value = searchInput.value;
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(value), 250);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const first = suggestionsEl.querySelector('.carrier-suggestion-item');
        if (first) {
          const text = first.querySelector('.suggestion-main').textContent || '';
          const dot = text.split('â€“')[0].trim();
          goToCarrier(dot);
        } else {
          goToCarrier(searchInput.value.trim());
        }
      }
    });

    searchBtn.addEventListener('click', () => {
      const first = suggestionsEl.querySelector('.carrier-suggestion-item');
      if (first) {
        const text = first.querySelector('.suggestion-main').textContent || '';
        const dot = text.split('â€“')[0].trim();
        goToCarrier(dot);
      } else {
        goToCarrier(searchInput.value.trim());
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-shell')) {
        clearSuggestions();
      }
    });

    loadCarriers();      // populates table (my carriers vs all)
    buildCarrierIndex(); // populates search index (always ALL carriers)

// ---------- SERVER-SIDE SORT HEADER HANDLERS ----------
document.addEventListener('DOMContentLoaded', function () {
  const table = document.getElementById('carriers-table');
  if (!table) return;

  const headers = Array.from(table.querySelectorAll('th.sortable'));

  function updateSortHeaderClasses() {
    headers.forEach(h => {
      h.classList.remove('sorted-asc', 'sorted-desc');
      if (h.dataset.col === sortBy) {
        h.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
    });
  }

  headers.forEach(th => {
    const colKey = th.dataset.col; // 'dot', 'mc', 'carrier', etc.

    th.addEventListener('click', () => {
      if (sortBy === colKey) {
        // toggle direction if clicking the same column
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        // new column: start ascending
        sortBy = colKey;
        sortDir = 'asc';
      }

      currentPage = 1;            // reset to first page when sort changes
      updateSortHeaderClasses();  // update arrow / underline classes
      loadCarriers();             // API will now get ?sortBy=...&sortDir=...
    });
  });

  // ðŸ”¥ apply default state (Carrier ASC) when page first loads
  updateSortHeaderClasses();
});




    
  </script>


<script>
  // Download ALL carriers for the current view (My Carriers or All),
  // using the current sortBy / sortDir.
  document.getElementById('download-btn')?.addEventListener('click', async () => {
    try {
      // 1) Decide which endpoint to hit
      let endpoint = '/api/carriers';
      try {
        const me = await fetch('/api/me').then(r => r.json());
        if (me.user) endpoint = '/api/my-carriers';
      } catch (e) {
        console.warn('me check failed, defaulting to /api/carriers');
      }

      if (!totalRows || totalRows <= 0) {
        alert('No carriers to export.');
        return;
      }

      // 2) Fetch ALL rows with current sort
      const url = new URL(endpoint, window.location.origin);
      url.searchParams.set('page', 1);
      url.searchParams.set('pageSize', totalRows);  // grab everything

      if (sortBy) {
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('sortDir', sortDir);
      }

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Export request failed: ${res.status}`);
      }

      const result = await res.json();
      const data = Array.isArray(result) ? result : result.rows;

      if (!data || !data.length) {
        alert('No carriers to export.');
        return;
      }

      // 3) Build CSV
      const lines = [];

      // Header row
      lines.push([
        'DOT',
        'MC',
        'Carrier',
        'Location',
        'Operating',
        'Common',
        'Contract',
        'Broker',
        'Safety Rating'
      ].join(','));

      const ratingMap = {
        'S': 'Satisfactory',
        'C': 'Conditional',
        'U': 'Unsatisfactory'
      };

      data.forEach(c => {
        const dotVal    = c.dot || c.dotnumber || c.id || '';
        const mc        = c.mc_number || '';
        const name      = c.legalname || c.dbaname || c.name || '';
        const location  = `${(c.city || c.phycity || '')}${
          (c.state || c.phystate) ? ', ' + (c.state || c.phystate) : ''
        }`;
        const operating = c.allowedtooperate === 'Y' ? 'Authorized' : 'Not Authorized';
        const common    = c.commonauthoritystatus || '';
        const contract  = c.contractauthoritystatus || '';
        const broker    = c.brokerauthoritystatus || '';
        const rawRating = c.safetyrating ? c.safetyrating.trim().toUpperCase() : '';
        const safety    = ratingMap[rawRating] || 'Not Rated';

        const cols = [dotVal, mc, name, location, operating, common, contract, broker, safety]
          .map(val => {
            let t = String(val ?? '').replace(/\s+/g, ' ').trim();
            // Escape commas/quotes/newlines for CSV
            if (/[",\n]/.test(t)) {
              t = '"' + t.replace(/"/g, '""') + '"';
            }
            return t;
          });

        lines.push(cols.join(','));
      });

      // 4) Trigger download
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const blobUrl = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = 'carriers.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);
    } catch (err) {
      console.error('CSV download failed', err);
      alert('Sorry, something went wrong generating the CSV.');
    }
  });
</script>
 

  
<script>
  async function initAuthUI() {
    try {
      const res = await fetch('/api/me');
      const data = await res.json();

      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');

      if (!loginBtn || !logoutBtn) return;

      if (data.user) {
        // Logged in
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

        logoutBtn.onclick = async () => {
          await fetch('/api/logout', { method: 'POST' });
          window.location.href = '/';
        };
      } else {
        // Not logged in
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
      }
    } catch (err) {
      console.error('auth ui error', err);
    }
  }

  // Make the login button act like a link
  document.getElementById("login-btn")?.addEventListener("click", () => {
    window.location.href = "/login.html";
  });

  initAuthUI();
</script>


<script>
  const tbody = document.getElementById('carrier-table-body');
  const selectAll = document.getElementById('select-all');
  const bulkBar = document.getElementById('bulk-actions');
  const selectedCountEl = document.getElementById('selected-count');
  const bulkRemoveBtn = document.getElementById('bulk-remove-btn');

  function updateBulkBar() {
    const selected = document.querySelectorAll('.row-select:checked');
    const count = selected.length;

    if (count === 0) {
      bulkBar.classList.add('hidden');
      selectAll.checked = false;
    } else {
      bulkBar.classList.remove('hidden');
      selectedCountEl.textContent = count;
      // if all visible checkboxes are selected, tick the header
      const allBoxes = document.querySelectorAll('.row-select');
      selectAll.checked = (count === allBoxes.length && allBoxes.length > 0);
    }
  }

  // When any row checkbox changes
  tbody.addEventListener('change', (e) => {
    if (e.target.classList.contains('row-select')) {
      updateBulkBar();
    }
  });

  // "Select All" toggle in header
  selectAll.addEventListener('change', () => {
    const allBoxes = document.querySelectorAll('.row-select');
    allBoxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
    updateBulkBar();
  });

  // Bulk Remove button
  bulkRemoveBtn.addEventListener('click', async () => {
    const selected = Array.from(document.querySelectorAll('.row-select:checked'));
    if (!selected.length) return;

    if (!confirm(`Remove ${selected.length} carriers from My Carriers?`)) {
      return;
    }

    // Remove each selected carrier via your existing DELETE route
    for (const cb of selected) {
      const dot = cb.dataset.dot;
      try {
        const res = await fetch(`/api/my-carriers/${encodeURIComponent(dot)}`, {
          method: 'DELETE'
        });

        if (res.status === 401) {
          alert('Your session expired. Please log in again.');
          window.location.href = '/login.html';
          return;
        }

        if (!res.ok) {
          console.error('Failed to remove', dot, await res.text());
        } else {
          // Remove the row from the table
          const row = cb.closest('tr');
          if (row) row.remove();
        }
      } catch (err) {
        console.error('Network error removing', dot, err);
      }
    }

    updateBulkBar();
  });
</script>

<!-- Bulk Import Modal -->
<div id="import-modal" class="import-modal hidden">
  <div class="import-modal-backdrop"></div>

  <div class="import-modal-dialog glass-card">
    <header class="import-modal-header">
      <div>
        <h2 class="import-modal-title">Carrier Import Wizard</h2>
        <p class="import-modal-subtitle">
          Add carriers in bulk from a CSV or by pasting DOT numbers.
        </p>
      </div>
      <button class="import-modal-close" id="import-modal-close" aria-label="Close">
        âœ•
      </button>
    </header>

    <!-- Step indicator (for later steps when you add preview/confirm) -->
    <div class="import-steps">
      <div class="import-step import-step-active">
        <span class="import-step-number">1</span>
        <span class="import-step-label">Upload</span>
      </div>
      <div class="import-step">
        <span class="import-step-number">2</span>
        <span class="import-step-label">Review</span>
      </div>
      <div class="import-step">
        <span class="import-step-number">3</span>
        <span class="import-step-label">Confirm</span>
      </div>
    </div>

    <!-- Method toggle -->
    <div class="import-method-toggle">
      <button class="import-method-btn import-method-active"
              type="button"
              data-import-method="csv">
        Upload CSV
      </button>
      <button class="import-method-btn"
              type="button"
              data-import-method="paste">
        Paste DOT list
      </button>
    </div>

    <!-- Panels -->
    <div class="import-panels">
      <!-- CSV panel -->
      <div id="import-panel-csv" class="import-panel active">
        <div id="csv-dropzone" class="dropzone">
          <input id="csv-file-input" type="file" accept=".csv" hidden>
          <div class="dropzone-inner">
            <p class="dropzone-title">Drop your CSV here</p>
            <p class="dropzone-subtitle">or click to browse files</p>
            <p class="dropzone-hint">
              Expecting a column named <code>DOT</code> or <code>dotnumber</code>.
            </p>
          </div>
        </div>

        <div class="import-help-row">
          <button id="browse-csv-btn" class="btn-secondary btn-xs" type="button">
            Choose fileâ€¦
          </button>

          <a href="/sample-carrier-import.csv"
             class="import-sample-link"
             download>
            Download sample CSV
          </a>
        </div>
      </div>

      <!-- Paste panel -->
      <div id="import-panel-paste" class="import-panel">
        <label for="dot-paste-textarea" class="paste-label">
          Paste one DOT per line
        </label>
        <textarea id="dot-paste-textarea"
                  class="paste-textarea"
                  rows="8"
                  placeholder="517125&#10;97615&#10;356489">
        </textarea>
        <p class="paste-hint">
          Weâ€™ll validate each DOT and ignore duplicates you already have.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <footer class="import-modal-footer">
      <button type="button"
              class="btn-ghost btn-sm"
              id="import-cancel-btn">
        Cancel
      </button>
      <button type="button"
              class="btn-primary btn-sm"
              id="import-next-btn">
        Next
      </button>
    </footer>
  </div>
</div>


<script>
  // --- Bulk Import modal wiring ---

  const bulkImportBtn   = document.getElementById('bulk-import-btn');
  const importModal     = document.getElementById('import-modal');
  const importCloseBtn  = document.getElementById('import-modal-close');
  const importCancelBtn = document.getElementById('import-cancel-btn');
  const importNextBtn   = document.getElementById('import-next-btn');

  function openImportModal() {
    if (!importModal) return;
    importModal.classList.remove('hidden');
  }

  function closeImportModal() {
    if (!importModal) return;
    importModal.classList.add('hidden');
  }

  if (bulkImportBtn) {
    bulkImportBtn.addEventListener('click', openImportModal);
  }

  [importCloseBtn, importCancelBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', closeImportModal);
    }
  });

  if (importModal) {
    importModal.addEventListener('click', e => {
      if (e.target === importModal) {
        closeImportModal();
      }
    });
  }

  // --- Method toggle (CSV vs Paste) ---

  const methodButtons = document.querySelectorAll('.import-method-btn');
  const csvPanel      = document.getElementById('import-panel-csv');
  const pastePanel    = document.getElementById('import-panel-paste');
  let importMethod    = 'csv'; // track current method

  function setImportMethod(method) {
    importMethod = method;

    methodButtons.forEach(btn => {
      const isActive = btn.dataset.importMethod === method;
      btn.classList.toggle('import-method-active', isActive);
    });

    if (csvPanel && pastePanel) {
      csvPanel.classList.toggle('active', method === 'csv');
      pastePanel.classList.toggle('active', method === 'paste');
    }
  }

  methodButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      setImportMethod(btn.dataset.importMethod);
    });
  });

  setImportMethod('csv');

  // --- CSV handling ---

  const dropzone     = document.getElementById('csv-dropzone');
  const fileInput    = document.getElementById('csv-file-input');
  const browseCsvBtn = document.getElementById('browse-csv-btn');

  let parsedDotsFromCsv = [];

  function parseDotsFromCsv(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) return [];

    const header = lines[0].split(',').map(h => h.trim().toLowerCase());

    // Look for a DOT column
    const dotIndex = header.findIndex(h =>
      ['dot', 'dotnumber', 'dot_number'].includes(h)
    );

    if (dotIndex === -1) {
      alert('Could not find a DOT column in the CSV header. Expected "DOT" or "dotnumber".');
      return [];
    }

    const dots = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',');
      const value = (cols[dotIndex] || '').trim();
      if (value && /^\d+$/.test(value)) {
        dots.push(value);
      }
    }

    // dedupe
    return [...new Set(dots)];
  }

  function handleFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];

    const reader = new FileReader();
    reader.onload = e => {
      parsedDotsFromCsv = parseDotsFromCsv(e.target.result);
      if (parsedDotsFromCsv.length) {
        console.log('Parsed DOTs from CSV:', parsedDotsFromCsv);
        alert(`Found ${parsedDotsFromCsv.length} DOT numbers in the CSV.`);
      } else {
        alert('No valid DOT numbers found in the CSV.');
      }
    };
    reader.readAsText(file);

    console.log('Selected file:', file.name);
  }

  if (browseCsvBtn && fileInput) {
    browseCsvBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFiles(e.target.files));
  }

  if (dropzone) {
    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('drop-active');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('drop-active');
      });
    });

    dropzone.addEventListener('drop', e => {
      const dt = e.dataTransfer;
      if (dt && dt.files) {
        handleFiles(dt.files);
      }
    });

    dropzone.addEventListener('click', () => {
      if (fileInput) fileInput.click();
    });
  }

  // --- Paste method handling ---

  const dotPasteTextarea = document.getElementById('dot-paste-textarea');

  function getDotsFromPaste() {
    if (!dotPasteTextarea) return [];
    const raw = dotPasteTextarea.value || '';
    const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const dots = lines.filter(v => /^\d+$/.test(v));
    return [...new Set(dots)];
  }

  // --- Next button: send to backend ---

  async function submitDotsToServer(dots) {
    if (!dots.length) {
      alert('No valid DOT numbers to import.');
      return;
    }

    try {
      const res = await fetch('/api/my-carriers/bulk', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ dots })
      });

      if (res.status === 401) {
        alert('You must be logged in to import carriers.');
        return;
      }

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        console.error('Bulk import failed:', errData);
        alert('Bulk import failed. Please try again.');
        return;
      }

      const data = await res.json();
      const s = data.summary || {};
      alert(
        `Import complete.\n\n` +
        `Submitted: ${s.totalSubmitted ?? dots.length}\n` +
        `Added: ${s.inserted ?? 0}\n` +
        `Duplicates: ${s.duplicates ?? 0}\n` +
        `Invalid: ${s.invalid ?? 0}`
      );

      closeImportModal();
      // Refresh the page so "My Carriers" shows new rows
      window.location.reload();

    } catch (err) {
      console.error('Error calling bulk import:', err);
      alert('Bulk import failed due to a network error.');
    }
  }

  if (importNextBtn) {
    importNextBtn.addEventListener('click', () => {
      let dots = [];

      if (importMethod === 'csv') {
        dots = parsedDotsFromCsv || [];
      } else if (importMethod === 'paste') {
        dots = getDotsFromPaste();
      }

      submitDotsToServer(dots);
    });
  }
</script>


</body>
</html>
