<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carrier Shark â€“ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style1.css">
</head>
<body class="carrier-list">
  <div class="bg-gradient"></div>
  <div class="bg-grid"></div>

  <!-- ðŸ”¥ ADD HEADER HERE  -->
  <header class="site-header glass-nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">CARRIER SHARK</a>
      </div>

      <nav class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/privacy" class="nav-link">Privacy Policy</a>
        <a href="/login.html" id="login-link">Login</a>
        <button id="logout-btn" style="display:none;">Logout</button>
      </nav>
    </div>
  </header>
  <!-- ðŸ”¥ END ADDED HEADER -->

  <div class="page">
    <header class="page-header">
      <div class="page-header-left">
        <h1 class="page-title">Carrier Shark</h1>
        <p class="page-subtitle">Find and manage vetted carriers</p>
      </div>
    </header>

    <!-- SEARCH SECTION -->
    <section class="glass-card search-shell">
      <div class="search-shell-header">
        <div>
          <h2 class="search-title">Search Carriers</h2>
          <p class="search-subtitle">Search by DOT number or carrier name</p>
        </div>
      </div>

<div class="search-row">
  <div class="search-input-wrap">
    <input
      id="search-input"
      class="search-input"
      type="text"
      placeholder="Start typing a DOT or carrier name..."
      autocomplete="off"
    />
    <ul id="carrier-suggestions" class="carrier-suggestions"></ul>
  </div>

  <button id="open-carrier-btn" class="search-btn">Search</button>
</div>


    </section>

    <!-- LIST SECTION -->
    <section class="glass-card carriers-card">
      <header class="carriers-card-header">
        <div>
          <h2 class="carriers-title">My Carriers</h2>
          <p class="carriers-subtitle">Click a DOT number to open its profile page.</p>
        </div>
        <button id="download-btn" class="download-btn">Download CSV</button>
      </header>


      <div class="carriers-table-wrap">
        
            <div id="bulk-actions" class="bulk-actions hidden">
              <span id="selected-count">0</span> selected
              <button id="bulk-remove-btn" class="bulk-remove-btn">
                Remove selected from My Carriers
              </button>
            </div>
              
        <table class="carriers-table">
          <thead>
            <tr>
              <th class="select-cell">
                <input type="checkbox" id="select-all">
              </th>
              <th>DOT</th>
              <th>MC</th>
              <th>Carrier</th>
              <th>Location</th>
              <th>Operating Status</th>
              <th>Common</th>
              <th>Contract</th>
              <th>Broker</th>
              <th>Safety Rating</th>
            </tr>
          </thead>
          <tbody id="carrier-table-body"></tbody>
        </table>



      </div>
    </section>
  </div>

  <script>

let carrierIndex = []; 
    // ---------- TABLE LOAD ----------
async function loadCarriers() {
  try {
    const tbody = document.getElementById('carrier-table-body');

    // ------------------------------------------
    // 1) CHECK IF USER IS LOGGED IN
    // ------------------------------------------
    let endpoint = '/api/carriers'; // default for guests

    try {
      const me = await fetch('/api/me').then(r => r.json());
      if (me.user) {
        endpoint = '/api/my-carriers'; // logged in â†’ use saved carriers
      }
    } catch (e) {
      console.error("Error checking login:", e);
    }
    
    const res = await fetch(endpoint);
    const data = await res.json();
    
        if (!Array.isArray(data) || data.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'No carriers found.';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        

        data.forEach(c => {
          const row = document.createElement('tr');
          const dotVal = c.dot || c.dotnumber || c.id || '';

            //  NEW: checkbox cell
          const selectCell = document.createElement('td');
          selectCell.className = 'col-select select-cell';  // add select-cell
        
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'row-select';
          checkbox.dataset.dot = dotVal;   // this is what we'll send to the API
        
          selectCell.appendChild(checkbox);
          row.appendChild(selectCell);
          

          const dotCell = document.createElement('td');
          const link = document.createElement('a');
          link.textContent = dotVal;
          link.href = '/' + encodeURIComponent(dotVal);
          link.className = 'dot-link';
          dotCell.appendChild(link);
          row.appendChild(dotCell);


          const mcCell = document.createElement('td');
          mcCell.textContent = c.mc_number || '-';
          row.appendChild(mcCell)

          // --- 1) CARRIER NAME ---
          const nameCell = document.createElement('td');
          nameCell.textContent = c.legalname || c.dbaname || c.name || '-';
          row.appendChild(nameCell);

         const locationCell = document.createElement('td');
          locationCell.textContent = `${(c.city || c.phycity || '')}${
            (c.state || c.phystate) ? ', ' + (c.state || c.phystate) : ''
          }`;
          row.appendChild(locationCell);
          
          const allowedtooperateCell = document.createElement('td');
          const isAuthorized = c.allowedtooperate === 'Y';
          
          allowedtooperateCell.textContent = isAuthorized
            ? 'Authorized'
            : 'Not Authorized';
          
          if (isAuthorized) {
            allowedtooperateCell.classList.add('status-ok');
          }
          
          row.appendChild(allowedtooperateCell);
          
          // COMMON
            const commonCell = document.createElement('td');
            commonCell.textContent = c.commonauthoritystatus || '-';
            if (commonCell.textContent === 'A') {
              commonCell.classList.add('status-ok');
            }
            row.appendChild(commonCell);

          
          // CONTRACT
            const contractCell = document.createElement('td');
            contractCell.textContent = c.contractauthoritystatus || '-';
            if (contractCell.textContent === 'A') {
              contractCell.classList.add('status-ok');
            }  
            row.appendChild(contractCell);

          
          // BROKER
            const brokerCell = document.createElement('td');
            brokerCell.textContent = c.brokerauthoritystatus || '-';
            if (brokerCell.textContent === 'A') {
              brokerCell.classList.add('status-ok');
            }
            row.appendChild(brokerCell);


          const safetyCell = document.createElement('td');
          safetyCell.textContent = c.safetyrating || 'Not Rated';
          row.appendChild(safetyCell);


          row.addEventListener('click', (e) => {
            // If the click came from the checkbox column, do nothing
            if (e.target.closest('.select-cell')) {
              return;
            }
          
            // Otherwise, treat it as a row click (unless it's the DOT link itself)
            if (e.target.tagName.toLowerCase() !== 'a') {
              window.location.pathname = '/' + encodeURIComponent(dotVal);
            }
          });


          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error fetching carriers:', err);
      }
    }

// ---------- BUILD AUTOCOMPLETE INDEX ----------
async function buildCarrierIndex() {
  try {
    const res = await fetch('/api/carriers');   // always ALL carriers
    const data = await res.json();
    carrierIndex = Array.isArray(data) ? data : [];
  } catch (err) {
    console.error("Error building search index:", err);
    carrierIndex = [];
  }
}


    // ---------- SEARCH / AUTOCOMPLETE ----------
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('open-carrier-btn');
    const suggestionsEl = document.getElementById('carrier-suggestions');
    let searchTimeout = null;

    function clearSuggestions() {
      suggestionsEl.innerHTML = '';
      suggestionsEl.classList.remove('open');
    }

    function goToCarrier(dot) {
      if (!dot) return;
      window.location.pathname = '/' + encodeURIComponent(dot);
    }

    function renderSuggestions(results) {
      clearSuggestions();
      if (!Array.isArray(results) || results.length === 0) return;

      results.forEach(item => {
        const li = document.createElement('li');
        li.className = 'carrier-suggestion-item';
        const dotVal = item.dot || item.dotnumber || item.id || '';
        const name = item.legalname || item.dbaname || '(No name)';
        const city = item.city || item.phycity || '';
        const state = item.state || item.phystate || '';
        const mc     = item.mc_number || '-';

        li.innerHTML = `
          <div class="suggestion-main">${name} - DOT: ${dotVal} â€“ MC: ${mc}</div>
          <div class="suggestion-sub">${city}${city && state ? ', ' : ''}${state}</div>
        `;
        li.addEventListener('click', () => goToCarrier(dotVal));
        suggestionsEl.appendChild(li);
      });

      suggestionsEl.classList.add('open');
    }

function performSearch(query) {
  const q = query.trim();
  if (q.length < 2) {
    clearSuggestions();
    return;
  }

  // Make sure we have the global carrierIndex loaded
  if (!Array.isArray(carrierIndex) || carrierIndex.length === 0) {
    clearSuggestions();
    return;
  }

  const qLower = q.toLowerCase();

  const matches = carrierIndex
    .filter(c => {
      const dot = String(c.dot || c.dotnumber || c.id || '');
      const mc   = String(c.mc_number || ''); 
      const name = (c.legalname || c.dbaname || c.name || '').toLowerCase();

      return dot.startsWith(q) || mc.startsWith(q) || name.includes(qLower);
    })
    .slice(0, 10);

  renderSuggestions(matches);
}


    searchInput.addEventListener('input', () => {
      const value = searchInput.value;
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(value), 250);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const first = suggestionsEl.querySelector('.carrier-suggestion-item');
        if (first) {
          const text = first.querySelector('.suggestion-main').textContent || '';
          const dot = text.split('â€“')[0].trim();
          goToCarrier(dot);
        } else {
          goToCarrier(searchInput.value.trim());
        }
      }
    });

    searchBtn.addEventListener('click', () => {
      const first = suggestionsEl.querySelector('.carrier-suggestion-item');
      if (first) {
        const text = first.querySelector('.suggestion-main').textContent || '';
        const dot = text.split('â€“')[0].trim();
        goToCarrier(dot);
      } else {
        goToCarrier(searchInput.value.trim());
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-shell')) {
        clearSuggestions();
      }
    });

    loadCarriers();      // populates table (my carriers vs all)
    buildCarrierIndex(); // populates search index (always ALL carriers)


document.getElementById("download-btn").addEventListener("click", () => {
  const table = document.querySelector(".carriers-table");
  const rows = table.querySelectorAll("tr");

  let csv = [];

  rows.forEach(row => {
    const cells = row.querySelectorAll("th, td");
    let rowData = [];

    cells.forEach(cell => {
      let text = cell.innerText.replace(/,/g, ""); // remove commas
      rowData.push(text);
    });

    csv.push(rowData.join(","));
  });

  const csvString = csv.join("\n");

  const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "carriers.csv";
  link.click();
});  
  </script>

<script>
  async function initAuthUI() {
    try {
      const res = await fetch('/api/me');
      const data = await res.json();

      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout-btn');

      if (!loginLink || !logoutBtn) return;

      if (data.user) {
        // logged in
        loginLink.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

        logoutBtn.onclick = async () => {
          await fetch('/api/logout', { method: 'POST' });
          window.location.href = '/';
        };
      } else {
        // not logged in
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
      }
    } catch (err) {
      console.error('auth ui error', err);
    }
  }

  initAuthUI();
</script>

<script>
  const tbody = document.getElementById('carrier-table-body');
  const selectAll = document.getElementById('select-all');
  const bulkBar = document.getElementById('bulk-actions');
  const selectedCountEl = document.getElementById('selected-count');
  const bulkRemoveBtn = document.getElementById('bulk-remove-btn');

  function updateBulkBar() {
    const selected = document.querySelectorAll('.row-select:checked');
    const count = selected.length;

    if (count === 0) {
      bulkBar.classList.add('hidden');
      selectAll.checked = false;
    } else {
      bulkBar.classList.remove('hidden');
      selectedCountEl.textContent = count;
      // if all visible checkboxes are selected, tick the header
      const allBoxes = document.querySelectorAll('.row-select');
      selectAll.checked = (count === allBoxes.length && allBoxes.length > 0);
    }
  }

  // When any row checkbox changes
  tbody.addEventListener('change', (e) => {
    if (e.target.classList.contains('row-select')) {
      updateBulkBar();
    }
  });

  // "Select All" toggle in header
  selectAll.addEventListener('change', () => {
    const allBoxes = document.querySelectorAll('.row-select');
    allBoxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
    updateBulkBar();
  });

  // Bulk Remove button
  bulkRemoveBtn.addEventListener('click', async () => {
    const selected = Array.from(document.querySelectorAll('.row-select:checked'));
    if (!selected.length) return;

    if (!confirm(`Remove ${selected.length} carriers from My Carriers?`)) {
      return;
    }

    // Remove each selected carrier via your existing DELETE route
    for (const cb of selected) {
      const dot = cb.dataset.dot;
      try {
        const res = await fetch(`/api/my-carriers/${encodeURIComponent(dot)}`, {
          method: 'DELETE'
        });

        if (res.status === 401) {
          alert('Your session expired. Please log in again.');
          window.location.href = '/login.html';
          return;
        }

        if (!res.ok) {
          console.error('Failed to remove', dot, await res.text());
        } else {
          // Remove the row from the table
          const row = cb.closest('tr');
          if (row) row.remove();
        }
      } catch (err) {
        console.error('Network error removing', dot, err);
      }
    }

    updateBulkBar();
  });
</script>



  
</body>
</html>
