<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carrier Vetting – Home</title>
  <link rel="stylesheet" href="style1.css">
</head>
<body class="carrier-page">
  <div class="bg-gradient"></div>
  <div class="bg-grid"></div>

  <div class="page">
    <header class="page-header">
      <div class="page-header-left">
        <h1 class="page-title">Carrier Vetting</h1>
        <p class="page-subtitle">Find and manage vetted carriers</p>
      </div>
    </header>

    <!-- SEARCH SECTION -->
    <section class="glass-card search-card">
      <h2 class="section-title">Search Carriers</h2>
      <p class="help-text">Search by DOT number or carrier name</p>

      <div class="search-bar">
        <input
          id="carrier-search-input"
          type="text"
          placeholder="Start typing a DOT or carrier name..."
          autocomplete="off"
        />
        <button id="carrier-search-btn">Open</button>
      </div>

      <ul id="carrier-suggestions" class="carrier-suggestions"></ul>
    </section>

    <!-- LIST SECTION -->
    <section class="glass-card list-card">
      <h2>My Carriers</h2>
      <p class="help-text">Click a DOT number to open its profile page.</p>

      <table>
        <thead>
          <tr>
            <th>DOT</th>
            <th>Address 1</th>
            <th>Address 2</th>
            <th>City</th>
            <th>State</th>
            <th>Zip</th>
          </tr>
        </thead>
        <tbody id="carrier-table-body"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ---------- TABLE LOAD ----------
    async function loadCarriers() {
      try {
        const res = await fetch('/api/carriers');
        const data = await res.json();
        const tbody = document.getElementById('carrier-table-body');

        if (!Array.isArray(data) || data.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'No carriers found.';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        data.forEach(c => {
          const row = document.createElement('tr');
          const dotVal = c.dot || c.dotnumber || c.id || '';

          const dotCell = document.createElement('td');
          const link = document.createElement('a');
          link.textContent = dotVal;
          link.href = '/' + encodeURIComponent(dotVal);
          link.className = 'dot-link';
          dotCell.appendChild(link);
          row.appendChild(dotCell);

          const address1Cell = document.createElement('td');
          address1Cell.textContent = c.address1 || c.phy_street || '';
          row.appendChild(address1Cell);

          const address2Cell = document.createElement('td');
          address2Cell.textContent = c.address2 || '';
          row.appendChild(address2Cell);

          const cityCell = document.createElement('td');
          cityCell.textContent = c.city || c.phycity || '';
          row.appendChild(cityCell);

          const stateCell = document.createElement('td');
          stateCell.textContent = c.state || c.phystate || '';
          row.appendChild(stateCell);

          const zipCell = document.createElement('td');
          zipCell.textContent = c.zip || c.phyzipcode || '';
          row.appendChild(zipCell);

          row.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'a') {
              window.location.pathname = '/' + encodeURIComponent(dotVal);
            }
          });

          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error fetching carriers:', err);
      }
    }

    // ---------- SEARCH / AUTOCOMPLETE ----------
    const searchInput = document.getElementById('carrier-search-input');
    const searchBtn = document.getElementById('carrier-search-btn');
    const suggestionsEl = document.getElementById('carrier-suggestions');
    let searchTimeout = null;

    function clearSuggestions() {
      suggestionsEl.innerHTML = '';
      suggestionsEl.classList.remove('open');
    }

    function goToCarrier(dot) {
      if (!dot) return;
      window.location.pathname = '/' + encodeURIComponent(dot);
    }

    function renderSuggestions(results) {
      clearSuggestions();
      if (!Array.isArray(results) || results.length === 0) return;

      results.forEach(item => {
        const li = document.createElement('li');
        li.className = 'carrier-suggestion-item';
        const dotVal = item.dot || item.dotnumber || item.id || '';
        const name = item.legalname || item.dbaname || '(No name)';
        const city = item.city || item.phycity || '';
        const state = item.state || item.phystate || '';

        li.innerHTML = `
          <div class="suggestion-main">${dotVal} – ${name}</div>
          <div class="suggestion-sub">${city}${city && state ? ', ' : ''}${state}</div>
        `;
        li.addEventListener('click', () => goToCarrier(dotVal));
        suggestionsEl.appendChild(li);
      });

      suggestionsEl.classList.add('open');
    }

    async function performSearch(query) {
      const q = query.trim();
      if (q.length < 2) {
        clearSuggestions();
        return;
      }

      try {
        const res = await fetch('/api/carriers/search?q=' + encodeURIComponent(q));
        const data = await res.json();
        renderSuggestions(data);
      } catch (err) {
        console.error('Error searching carriers:', err);
      }
    }

    searchInput.addEventListener('input', () => {
      const value = searchInput.value;
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(value), 250);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const first = suggestionsEl.querySelector('.carrier-suggestion-item');
        if (first) {
          const text = first.querySelector('.suggestion-main').textContent || '';
          const dot = text.split('–')[0].trim();
          goToCarrier(dot);
        } else {
          goToCarrier(searchInput.value.trim());
        }
      }
    });

    searchBtn.addEventListener('click', () => {
      const first = suggestionsEl.querySelector('.carrier-suggestion-item');
      if (first) {
        const text = first.querySelector('.suggestion-main').textContent || '';
        const dot = text.split('–')[0].trim();
        goToCarrier(dot);
      } else {
        goToCarrier(searchInput.value.trim());
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-card')) {
        clearSuggestions();
      }
    });

    loadCarriers();
  </script>
</body>
</html>
